<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Suivi – Montres & Colis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <style>
    :root {
      color-scheme: light dark;
      --bg: #f9fafb; --bg-card:#ffffff; --border:#e5e7eb;
      --text:#111827; --text-muted:#6b7280; --accent:#111827;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#020617; --bg-card:#020617; --border:#1e293b;
        --text:#e5e7eb; --text-muted:#9ca3af; --accent:#f9fafb;
      }
    }
    body{
      margin:0 auto;max-width:800px;padding:1rem;
      font-family:system-ui;background:var(--bg);color:var(--text);
    }
    h1{text-align:center;margin:0.5rem 0 0.2rem;}
    h2{margin:1.5rem 0 0.6rem;font-size:1.15rem;}
    .subtitle{text-align:center;color:var(--text-muted);font-size:0.85rem;margin:0;}
    .stats{text-align:center;color:var(--text-muted);margin:1rem 0;font-size:0.8rem;}

    .section-list{display:grid;gap:1rem;}
    @media(min-width:700px){.section-list{grid-template-columns:1fr 1fr;}}

    .list{display:flex;flex-direction:column;gap:0.5rem;}
    .empty{color:var(--text-muted);font-style:italic;}

    button{cursor:pointer;border:none;border-radius:0.5rem;font-size:0.85rem;padding:0.4rem 0.8rem;}
    .action-btn{border-radius:999px;padding:0.25rem 0.6rem;font-size:0.75rem;}

    .clear-btn{background:#b91c1c;color:white;}
    .clear-btn:hover{background:#dc2626;}

    .card{
      background:var(--bg-card);border:1px solid var(--border);
      border-radius:0.75rem;padding:0.7rem;display:flex;flex-direction:column;gap:0.4rem;
    }
    .card-main{display:flex;gap:0.7rem;cursor:pointer;}
    .thumb{
      width:56px;height:56px;border-radius:0.4rem;overflow:hidden;
      background:#0f172a;display:flex;align-items:center;justify-content:center;color:white;font-size:0.75rem;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;}

    .card-label{font-weight:600;font-size:0.95rem;}
    .card-meta{color:var(--text-muted);font-size:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;}

    .tag{
      padding:0.1rem 0.5rem;border-radius:999px;font-size:0.7rem;
      background:#e5e7eb;color:#374151;margin-right:0.3rem;margin-top:0.2rem;
    }
    @media(prefers-color-scheme:dark){.tag{background:#111827;color:#e5e7eb;}}
    .tag.active{border:1px solid var(--accent);}

    .carrier{background:#0f172a;color:white;border:1px solid #475569;}
    .status{border:1px solid #4b5563;}

    .panel-toggle{
      width:100%;background:transparent;border:1px solid var(--border);
      border-radius:0.75rem;padding:0.5rem 0.7rem;text-align:left;
      display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;
    }
    .panel{display:none;margin-top:0.5rem;}

    .form-box{
      background:var(--bg-card);border:1px solid var(--border);
      border-radius:0.75rem;padding:1rem;margin-top:2rem;
    }
    .form-row{margin-bottom:0.8rem;}
    input,select,textarea{
      width:100%;padding:0.4rem;border-radius:0.4rem;
      border:1px solid #4b5563;background:transparent;color:inherit;
    }
    textarea{resize:vertical;}
    .small{font-size:0.8rem;color:var(--text-muted);}

    #tag-filters{margin-top:0.7rem;margin-bottom:0.7rem;}
    #tag-filters .tag{border:none;}
  </style>
</head>

<body>

<h1>Suivi montres & colis</h1>
<p class="subtitle">Application installable – photos, tags, archivage, import/export</p>
<p id="stats" class="stats"></p>

<div id="tag-filters"></div>

<div class="section-list">
  <div>
    <h2>Montres</h2>
    <div id="watch-list" class="list"></div>
    <p id="watch-empty" class="empty" style="display:none;">Aucune entrée.</p>
  </div>
  <div>
    <h2>Colis</h2>
    <div id="parcel-list" class="list"></div>
    <p id="parcel-empty" class="empty" style="display:none;">Aucune entrée.</p>
  </div>
</div>

<div class="form-box">
  <h2 id="form-title">Ajouter un lien</h2>
  <form id="form">
    <div class="form-row">
      <label>Catégorie</label>
      <select id="type">
        <option value="watch">Montre</option>
        <option value="parcel">Colis</option>
      </select>
    </div>
    <div class="form-row">
      <label>Nom</label>
      <input id="label" required placeholder="Ex : Révision Seiko">
    </div>
    <div class="form-row">
      <label>Lien de suivi</label>
      <input id="url" required placeholder="https://...">
    </div>
    <div class="form-row">
      <label>Tags (séparés par des virgules)</label>
      <input id="tags">
    </div>
    <div class="form-row">
      <label>Date d’ajout</label>
      <input type="date" id="createdAt">
    </div>
    <div class="form-row">
      <label>Image (URL ou fichier)</label>
      <input id="imgUrl" placeholder="https://image.jpg">
      <input type="file" id="imgFile" accept="image/*">
    </div>
    <button id="submit" type="submit" style="background:#111827;color:white;">Ajouter</button>
    <p id="edit-note" class="small" style="display:none;">Mode édition activé.</p>
  </form>
</div>

<div style="margin-top:2rem;">
  <button class="panel-toggle" id="toggle-arch"><span id="arrow-arch">▶</span> Archivés (<span id="arch-count">0</span>)</button>
  <div class="panel" id="arch-panel">
    <div id="archive-list" class="list"></div>
    <p id="archive-empty" class="empty" style="display:none;">Rien en archive.</p>
  </div>
</div>

<div style="margin-top:2rem;">
  <button class="panel-toggle" id="toggle-exp"><span id="arrow-exp">▶</span> Export / Import / Backup</button>
  <div class="panel" id="exp-panel">
    <button id="export">Exporter (.txt)</button>
    <button id="import-text">Importer depuis texte</button>
    <button id="import-file-btn">Importer fichier</button>
    <input type="file" id="import-file" accept=".txt,.json" style="display:none">
    <textarea id="json-area" placeholder="Zone d’export/import…" style="margin-top:1rem;"></textarea>
    <button id="restore">Restaurer dernier backup</button>
    <p id="backup-info" class="small"></p>
    <button class="clear-btn" id="clear-all">Effacer toutes les données</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ==== Clés identiques à ta version précédente ==== */
  const K_W = "watchLinksV2";
  const K_P = "parcelLinksV2";
  const K_B = "suiviBackupV1";

  let editId = null;
  let editType = null;
  let filterTag = null;

  const getRaw = k => localStorage.getItem(k);
  const get = k => {
    try { return JSON.parse(getRaw(k) || "[]"); }
    catch { return []; }
  };
  const save = (k,v) => {
    try{ localStorage.setItem(k, JSON.stringify(v)); }
    catch(e){ alert("Stockage plein (probablement à cause des photos)."); }
  };

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(",").map(x=>x.trim()).filter(Boolean);
  }

  function fmtDate(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    if(isNaN(d.getTime())) return "—";
    return d.toLocaleDateString("fr-CH");
  }
  const sortByDate = arr => arr.slice().sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0));

  const detectCarrier = url =>{
    url = (url||"").toLowerCase();
    if(url.includes("ups")) return "UPS";
    if(url.includes("dhl")) return "DHL";
    if(url.includes("fedex")) return "FedEx";
    if(url.includes("poste")) return "La Poste";
    if(url.includes("chronopost")) return "Chronopost";
    return null;
  };

  const stripImages = arr => arr.map(o=>{
    o={...o};
    if(o.imageUrl && String(o.imageUrl).startsWith("data:")) delete o.imageUrl;
    return o;
  });

  function backup(){
    const data = {
      createdAt:new Date().toISOString(),
      watches:stripImages(get(K_W)),
      parcels:stripImages(get(K_P))
    };
    try{ localStorage.setItem(K_B, JSON.stringify(data)); }catch{}
    renderBackupInfo();
  }

  function render(){
    renderList("watch", get(K_W));
    renderList("parcel", get(K_P));
    renderTags();
    renderStats();
    renderArchive();
    renderBackupInfo();
  }

  function renderList(type, arr){
    const list = document.getElementById(type+"-list");
    const empty = document.getElementById(type+"-empty");
    list.innerHTML = "";

    let items = arr.filter(x=>x.status!=="archived");
    if(filterTag) items = items.filter(x=>normalizeTags(x.tags).includes(filterTag));
    items = sortByDate(items);

    empty.style.display = items.length ? "none" : "block";
    items.forEach(x=> list.appendChild(card(x,type)));
  }

  function card(item,type){
    const c=document.createElement("div"); c.className="card";

    const main=document.createElement("div"); main.className="card-main";
    main.onclick=()=> item.url && window.open(item.url,"_blank");

    const th=document.createElement("div"); th.className="thumb";
    if(item.imageUrl){ const img=new Image(); img.src=item.imageUrl; th.appendChild(img); }
    else th.textContent= type==="watch"?"Montre":"Colis";

    const content=document.createElement("div");
    const carrier = type==="parcel" ? detectCarrier(item.url) : null;
    content.innerHTML = `
      <div class="card-label">${item.label || (type==="watch"?"Montre":"Colis")}</div>
      <div class="card-meta">
        <span>Ajouté le ${fmtDate(item.createdAt)}</span>
        <span class="status">${item.status==="archived"?"Archivé":"Actif"}</span>
        ${carrier?`<span class="tag carrier">${carrier}</span>`:""}
      </div>
    `;

    const tagsBox=document.createElement("div");
    normalizeTags(item.tags).forEach(t=>{
      const el=document.createElement("span");
      el.className="tag"+(t===filterTag?" active":"");
      el.textContent=t;
      el.onclick=e=>{
        e.stopPropagation();
        filterTag = (filterTag===t?null:t);
        render();
      };
      tagsBox.appendChild(el);
    });
    if(tagsBox.childNodes.length) content.appendChild(tagsBox);

    main.append(th,content);
    c.appendChild(main);

    const acts=document.createElement("div");
    acts.style.marginTop="0.3rem"; acts.style.display="flex"; acts.style.gap="0.4rem";

    const bEdit=document.createElement("button");
    bEdit.textContent="Modifier"; bEdit.className="action-btn";
    bEdit.onclick=e=>{e.stopPropagation(); loadEdit(item,type);};

    const bDel=document.createElement("button");
    bDel.textContent="Supprimer"; bDel.className="action-btn"; bDel.style.background="#b91c1c"; bDel.style.color="white";
    bDel.onclick=e=>{e.stopPropagation(); removeItem(item.id,type);};

    const bArc=document.createElement("button");
    bArc.textContent=item.status==="archived"?"Restaurer":"Archiver";
    bArc.className="action-btn"; bArc.style.background="#1d4ed8"; bArc.style.color="white";
    bArc.onclick=e=>{e.stopPropagation(); toggleArchive(item.id,type);};

    acts.append(bEdit,bDel,bArc);
    c.appendChild(acts);

    return c;
  }

  function renderTags(){
    const box=document.getElementById("tag-filters");
    box.innerHTML="";

    const tags=new Set();
    [...get(K_W),...get(K_P)].forEach(x=>normalizeTags(x.tags).forEach(t=>tags.add(t)));
    if(!tags.size) return;

    const all=document.createElement("button");
    all.textContent="Tous";
    all.className="tag"+(filterTag? "":" active");
    all.onclick=()=>{filterTag=null;render();};
    box.appendChild(all);

    [...tags].sort().forEach(t=>{
      const b=document.createElement("button");
      b.textContent=t;
      b.className="tag"+(filterTag===t?" active":"");
      b.onclick=()=>{filterTag=filterTag===t?null:t;render();};
      box.appendChild(b);
    });
  }

  function renderStats(){
    const w=get(K_W), p=get(K_P);
    const wA=w.filter(x=>x.status!=="archived").length;
    const pA=p.filter(x=>x.status!=="archived").length;
    document.getElementById("stats").textContent=`Montres : ${wA} | Colis : ${pA}`;
  }

  function renderArchive(){
    const list=document.getElementById("archive-list");
    const count=document.getElementById("arch-count");
    const empty=document.getElementById("archive-empty");
    list.innerHTML="";

    let arch=[...get(K_W).map(x=>({...x,__t:"watch"})),...get(K_P).map(x=>({...x,__t:"parcel"}))]
      .filter(x=>x.status==="archived");

    if(filterTag) arch=arch.filter(x=>normalizeTags(x.tags).includes(filterTag));
    arch=sortByDate(arch);

    count.textContent=arch.length;
    empty.style.display = arch.length?"none":"block";
    arch.forEach(x=>list.appendChild(card(x,x.__t)));
  }

  function renderBackupInfo(){
    const box=document.getElementById("backup-info");
    const raw=getRaw(K_B);
    if(!raw){ box.textContent="Aucun backup."; return; }
    try{
      const d=new Date(JSON.parse(raw).createdAt);
      box.textContent="Sauvegarde : "+d.toLocaleString("fr-CH");
    }catch{
      box.textContent="Backup illisible.";
    }
  }

  function loadEdit(item,type){
    editId=item.id; editType=type;
    document.getElementById("form-title").textContent="Modifier un lien";
    document.getElementById("edit-note").style.display="block";

    document.getElementById("type").value=type;
    document.getElementById("label").value=item.label||"";
    document.getElementById("url").value=item.url||"";
    document.getElementById("tags").value=normalizeTags(item.tags).join(", ");
    document.getElementById("createdAt").value=(item.createdAt||"").slice(0,10);
    document.getElementById("imgUrl").value=item.imageUrl && !String(item.imageUrl).startsWith("data:") ? item.imageUrl : "";
    document.getElementById("imgFile").value="";
    window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
  }

  function removeItem(id,type){
    if(!confirm("Supprimer cette entrée ?")) return;
    const k=type==="watch"?K_W:K_P;
    save(k, get(k).filter(x=>x.id!==id));
    resetForm();
    backup();
    render();
  }

  function toggleArchive(id,type){
    const k=type==="watch"?K_W:K_P;
    const arr=get(k);
    const it=arr.find(x=>x.id===id);
    if(!it) return;
    it.status = it.status==="archived" ? "active" : "archived";
    save(k,arr);
    backup();
    render();
  }

  document.getElementById("form").addEventListener("submit", e =>{
    e.preventDefault();
    const type=document.getElementById("type").value;
    const label=document.getElementById("label").value.trim();
    let url=document.getElementById("url").value.trim();
    const tags=normalizeTags(document.getElementById("tags").value);
    const dateField=document.getElementById("createdAt").value;
    const imgUrlField=document.getElementById("imgUrl").value.trim();
    const file=document.getElementById("imgFile").files[0];
    if(!label || !url) return;
    if(!/^https?:\/\//i.test(url)) url="https://"+url;

    const k = type==="watch"?K_W:K_P;
    const existing = editId ? get(editType==="watch"?K_W:K_P).find(x=>x.id===editId) : null;
    const finalDate = dateField
        ? new Date(dateField+"T12:00:00").toISOString()
        : (existing ? existing.createdAt : new Date().toISOString());

    function apply(finalImg){
      const obj = {
        id: editId || (type+"-"+Date.now()+"-"+Math.random().toString(16).slice(2)),
        label, url, tags,
        createdAt: finalDate,
        status: existing ? (existing.status||"active") : "active",
        imageUrl: finalImg || imgUrlField || (existing ? existing.imageUrl : "")
      };

      if(editId){
        const oldK = editType==="watch"?K_W:K_P;
        save(oldK, get(oldK).filter(x=>x.id!==editId));
      }

      const current=get(k);
      current.push(obj);
      save(k,current);

      resetForm();
      filterTag=null;
      backup();
      render();
    }

    if(file){
      const r=new FileReader();
      r.onload = ev => apply(ev.target.result);
      r.readAsDataURL(file);
    } else {
      apply(null);
    }
  });

  function resetForm(){
    editId=null; editType=null;
    document.getElementById("form").reset();
    document.getElementById("form-title").textContent="Ajouter un lien";
    document.getElementById("edit-note").style.display="none";
  }

  document.getElementById("export").onclick=()=>{
    const data={createdAt:new Date().toISOString(),watches:get(K_W),parcels:get(K_P)};
    const txt=JSON.stringify(data,null,2);
    document.getElementById("json-area").value=txt;
    const blob=new Blob([txt],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="suivi_backup.txt";
    a.click();
  };

  document.getElementById("import-text").onclick=()=>{
    try{
      const d=JSON.parse(document.getElementById("json-area").value);
      save(K_W,d.watches||[]);
      save(K_P,d.parcels||[]);
      resetForm(); filterTag=null;
      backup(); render();
      alert("Import réussi.");
    }catch{ alert("JSON invalide."); }
  };

  document.getElementById("import-file-btn").onclick=()=>document.getElementById("import-file").click();
  document.getElementById("import-file").onchange=e=>{
    const f=e.target.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload = ev=>{
      try{
        const d=JSON.parse(ev.target.result);
        save(K_W,d.watches||[]);
        save(K_P,d.parcels||[]);
        resetForm(); filterTag=null;
        backup(); render();
        alert("Import depuis fichier réussi.");
      }catch{ alert("Fichier JSON invalide."); }
    };
    r.readAsText(f);
  };

  document.getElementById("restore").onclick=()=>{
    const raw=getRaw(K_B);
    if(!raw) return alert("Aucun backup.");
    if(!confirm("Restaurer le dernier backup ?")) return;
    try{
      const d=JSON.parse(raw);
      save(K_W,d.watches||[]);
      save(K_P,d.parcels||[]);
      resetForm(); filterTag=null;
      render();
    }catch{ alert("Backup corrompu."); }
  };

  document.getElementById("clear-all").onclick=()=>{
    if(!confirm("Effacer toutes les données locales ?")) return;
    localStorage.removeItem(K_W);
    localStorage.removeItem(K_P);
    localStorage.removeItem(K_B);
    filterTag=null;
    resetForm();
    render();
  };

  document.getElementById("toggle-arch").onclick=()=>{
    const p=document.getElementById("arch-panel");
    const a=document.getElementById("arrow-arch");
    const open=p.style.display==="block";
    p.style.display=open?"none":"block";
    a.textContent=open?"▶":"▼";
  };

  document.getElementById("toggle-exp").onclick=()=>{
    const p=document.getElementById("exp-panel");
    const a=document.getElementById("arrow-exp");
    const open=p.style.display==="block";
    p.style.display=open?"none":"block";
    a.textContent=open?"▶":"▼";
  };

  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }

  render();
});
</script>
</body>
</html>
