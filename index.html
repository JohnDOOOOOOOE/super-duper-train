<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Suivi montres & colis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <style>
    :root {
      color-scheme: light dark;
      --bg: #f9fafb;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --text-muted: #6b7280;
      --accent: #111827;
      --tag-bg: #e5e7eb;
      --tag-text: #374151;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #020617;
        --bg-card: #020617;
        --border: #1e293b;
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --accent: #f9fafb;
        --tag-bg: #111827;
        --tag-text: #e5e7eb;
      }
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      text-align: center;
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.15rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .stats-line {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .lists-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 700px) {
      .lists-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .list { display: flex; flex-direction: column; gap: 0.5rem; }

    .card {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
    }
    .card-main {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      cursor: pointer;
    }
    .card:hover {
      border-color: var(--accent);
    }

    .thumb {
      flex: 0 0 56px;
      height: 56px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #e5e7eb;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-content { flex: 1; min-width: 0; }
    .card-label {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.15rem;
      word-break: break-word;
    }
    .card-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .tags { margin-top: 0.3rem; display: flex; flex-wrap: wrap; gap: 0.25rem; }
    .tag {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: var(--tag-bg);
      color: var(--tag-text);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .tag.active { border-color: var(--accent); }

    .carrier-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #475569;
    }

    .status-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }
    .card-actions button {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .card-actions .edit-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .card-actions .delete-btn {
      background: #b91c1c;
      color: #f9fafb;
    }
    .card-actions .archive-btn {
      background: #1d4ed8;
      color: #f9fafb;
    }

    .empty {
      font-size: 0.9rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .form-container {
      margin-top: 2rem;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
    }

    .form-row { margin-bottom: 0.75rem; }
    label { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }

    input[type="text"], input[type="url"], input[type="date"], select, textarea, input[type="file"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #4b5563;
      background: transparent;
      color: inherit;
      font-size: 0.9rem;
    }
    textarea { resize: vertical; }

    button {
      padding: 0.5rem 0.9rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #submit-btn {
      background-color: #111827;
      color: #f9fafb;
    }
    button[type="button"] {
      background: #4b5563;
      color: #f9fafb;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .tag-filter-container { margin-bottom: 0.75rem; font-size: 0.85rem; }
    .tag-filter-list { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.25rem; }
    .tag-filter-pill {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: var(--tag-bg);
      color: var(--tag-text);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .tag-filter-pill.active { border-color: var(--accent); }

    .export-layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .export-left { flex: 1; }
    .export-right { align-self: flex-end; }
    @media (min-width: 600px) {
      .export-layout {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      .export-left { margin-right: 1rem; }
      .export-right { text-align: right; }
    }
    #export-data { min-height: 80px; width: 100%; }

    .archive-section,
    .export-section {
      margin-top: 2rem;
    }
    .archive-toggle,
    .export-toggle {
      width: 100%;
      text-align: left;
      background: transparent;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      padding: 0.5rem 0.7rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .archive-toggle span.arrow,
    .export-toggle span.arrow {
      font-size: 0.9rem;
    }

    /* üî¥ Bouton rouge pour effacer toutes les donn√©es */
    .clear-btn {
      background: #b91c1c;
      color: #f9fafb;
    }
    .clear-btn:hover {
      background: #dc2626;
    }
  </style>
</head>

<body>
  <h1>Suivi montres & colis</h1>
  <p class="subtitle">Application Web installable ‚Äì liens Tempora & colis, avec tags, photos, √©dition, stats, archivage & tri par date.</p>
  <p id="stats" class="stats-line"></p>

  <!-- Filtre par tag -->
  <div class="tag-filter-container">
    <span class="tag-filter-label">Filtrer par tag :</span>
    <div id="tag-filter-list" class="tag-filter-list"></div>
  </div>

  <!-- Deux colonnes (Montres / Colis) -->
  <div class="lists-container">
    <div class="section">
      <h2>Montres</h2>
      <div id="watch-list" class="list"></div>
      <p id="watch-empty" class="empty" style="display:none;">Aucune montre enregistr√©e.</p>
    </div>

    <div class="section">
      <h2>Colis</h2>
      <div id="parcel-list" class="list"></div>
      <p id="parcel-empty" class="empty" style="display:none;">Aucun colis enregistr√©.</p>
    </div>
  </div>

  <!-- Formulaire -->
  <div class="form-container">
    <h2 id="form-title">Ajouter un lien</h2>
    <form id="add-form">
      <div class="form-row">
        <label>Cat√©gorie</label>
        <select id="type">
          <option value="watch">Montre</option>
          <option value="parcel">Colis</option>
        </select>
      </div>

      <div class="form-row">
        <label>Nom / Descriptif</label>
        <input id="label" type="text" required placeholder="Ex : Tank Must r√©vision, Colis UPS‚Ä¶">
      </div>

      <div class="form-row">
        <label>Lien de suivi</label>
        <input id="url" type="url" required placeholder="https://...">
      </div>

      <div class="form-row">
        <label>Tags (s√©par√©s par virgules)</label>
        <input id="tags" type="text" placeholder="vintage, UPS, r√©vision‚Ä¶">
      </div>

      <div class="form-row">
        <label>Date (optionnelle)</label>
        <input id="createdAt" type="date">
        <p class="small">
          Si tu laisses vide, la date d'aujourd'hui sera utilis√©e.
        </p>
      </div>

      <div class="form-row">
        <label>Image (URL ou depuis l'appareil)</label>
        <input id="imageUrl" type="url" placeholder="https://image.jpg (optionnel)">
        <input id="imageFile" type="file" accept="image/*">
        <p class="small">
          Tu peux soit coller une URL d'image, soit choisir une image locale (elle sera stock√©e dans l'app).
        </p>
      </div>

      <div class="form-row">
        <button id="submit-btn" type="submit">Ajouter</button>
        <p class="small" id="edit-hint" style="display:none;">
          Mode √©dition activ√© ‚Äì tu modifies une entr√©e existante.
        </p>
      </div>
    </form>
  </div>

  <!-- Section Archiv√©s (volet) -->
  <div class="archive-section">
    <button type="button" id="archive-toggle" class="archive-toggle">
      <span id="archive-arrow" class="arrow">‚ñ∂</span>
      <span>Archiv√©s (</span><span id="archive-count">0</span><span>)</span>
    </button>
    <div id="archive-container" style="display:none; margin-top:0.5rem;">
      <div id="archive-list" class="list"></div>
      <p id="archive-empty" class="empty" style="display:none;">Aucun √©l√©ment archiv√©.</p>
    </div>
  </div>

  <!-- Section Export / Import / Sauvegarde (volet) -->
  <div class="export-section">
    <button type="button" id="export-toggle" class="export-toggle">
      <span id="export-arrow" class="arrow">‚ñ∂</span>
      <span>Export / Import / Sauvegarde</span>
    </button>
    <div id="export-container" style="display:none; margin-top:0.5rem;">
      <div class="export-import">
        <div class="export-layout">
          <div class="export-left">
            <div class="form-row">
              <button type="button" id="export-btn">Exporter (t√©l√©charger .txt)</button>
              <button type="button" id="import-btn">Importer depuis le texte</button>
              <button type="button" id="import-file-btn">Importer un fichier</button>
              <input type="file" id="import-file" accept=".txt,application/json" style="display:none;">
            </div>
            <div class="form-row">
              <label for="export-data">Donn√©es JSON</label>
              <textarea id="export-data" placeholder="Exporter puis copier, ou coller ici pour importer."></textarea>
            </div>
          </div>
          <div class="export-right">
            <button type="button" id="restore-backup">Restaurer le dernier backup</button>
            <p class="small" id="backup-info">Aucune sauvegarde locale pour l'instant.</p>
            <div style="margin-top:0.75rem;">
              <button type="button" id="clear-storage" class="clear-btn">Effacer toutes les donn√©es locales</button>
              <p class="small">
                Ce bouton supprime toutes les montres & colis stock√©s localement sur cet appareil.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WATCH_KEY = "watchLinksV2";
    const PARCEL_KEY = "parcelLinksV2";
    const BACKUP_KEY = "suiviBackupV1";

    let activeTagFilter = null;
    let editingId = null;
    let editingType = null;
    let archiveOpen = false;
    let exportOpen = false;

    function enrichEntries(key, arr) {
      let changed = false;
      arr.forEach((item) => {
        if (!item.id) {
          item.id = key + "-" + Date.now() + "-" + Math.random().toString(16).slice(2);
          changed = true;
        }
        if (!item.createdAt) {
          item.createdAt = new Date().toISOString();
          changed = true;
        }
        if (!item.status) {
          item.status = "active";
          changed = true;
        }
      });
      if (changed) {
        localStorage.setItem(key, JSON.stringify(arr));
      }
      return arr;
    }

    function loadStored(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return enrichEntries(key, parsed);
      } catch {
        return [];
      }
    }

    function saveStored(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }

    function updateBackup() {
      try {
        const backup = {
          createdAt: new Date().toISOString(),
          watches: loadStored(WATCH_KEY),
          parcels: loadStored(PARCEL_KEY)
        };
        localStorage.setItem(BACKUP_KEY, JSON.stringify(backup));
        renderBackupInfo();
      } catch {}
    }

    function normalizeTags(tags) {
      if (!tags) return [];
      return String(tags)
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString("fr-CH");
      } catch {
        return "";
      }
    }

    function isoToDateInput(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      } catch {
        return "";
      }
    }

    function detectCarrier(url) {
      const lower = (url || "").toLowerCase();
      if (lower.includes("ups")) return "UPS";
      if (lower.includes("laposte") || lower.includes("poste.ch") || lower.includes("post.ch")) return "La Poste";
      if (lower.includes("dhl")) return "DHL";
      if (lower.includes("fedex")) return "FedEx";
      if (lower.includes("chronopost")) return "Chronopost";
      if (lower.includes("colissimo")) return "Colissimo";
      return null;
    }

    function sortByDateDesc(items) {
      return [...items].sort((a, b) => {
        const da = new Date(a.createdAt);
        const db = new Date(b.createdAt);
        const ta = isNaN(da.getTime()) ? 0 : da.getTime();
        const tb = isNaN(db.getTime()) ? 0 : db.getTime();
        return tb - ta;
      });
    }

    function createCard(item, type) {
      const isWatch = type === "watch";
      const card = document.createElement("div");
      card.className = "card";

      const main = document.createElement("div");
      main.className = "card-main";
      main.addEventListener("click", () => {
        if (item.url) {
          window.open(item.url, "_blank", "noopener");
        }
      });

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if (item.imageUrl) {
        const img = document.createElement("img");
        img.src = item.imageUrl;
        img.alt = item.label || "";
        thumb.appendChild(img);
      } else {
        thumb.textContent = isWatch ? "Montre" : "Colis";
      }

      const content = document.createElement("div");
      content.className = "card-content";

      const labelEl = document.createElement("div");
      labelEl.className = "card-label";
      labelEl.textContent = item.label || (isWatch ? "Montre" : "Colis");

      const metaEl = document.createElement("div");
      metaEl.className = "card-meta";

      const dateText = formatDate(item.createdAt);
      if (dateText) {
        const dateSpan = document.createElement("span");
        dateSpan.textContent = "Ajout√© le " + dateText;
        metaEl.appendChild(dateSpan);
      }

      const statusSpan = document.createElement("span");
      statusSpan.className = "status-badge";
      statusSpan.textContent = item.status === "archived" ? "Archiv√©" : "Actif";
      metaEl.appendChild(statusSpan);

      if (!isWatch) {
        const carrier = detectCarrier(item.url);
        if (carrier) {
          const carrierSpan = document.createElement("span");
          carrierSpan.className = "carrier-badge";
          carrierSpan.textContent = carrier;
          metaEl.appendChild(carrierSpan);
        }
      }

      content.appendChild(labelEl);
      if (metaEl.childNodes.length > 0) content.appendChild(metaEl);

      const tags = normalizeTags(item.tags);
      if (tags.length > 0) {
        const tagsEl = document.createElement("div");
        tagsEl.className = "tags";
        tags.forEach(tag => {
          const t = document.createElement("span");
          t.className = "tag";
          if (activeTagFilter === tag) t.classList.add("active");
          t.textContent = tag;
          t.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleTagFilter(tag);
          });
          tagsEl.appendChild(t);
        });
        content.appendChild(tagsEl);
      }

      main.appendChild(thumb);
      main.appendChild(content);
      card.appendChild(main);

      const actions = document.createElement("div");
      actions.className = "card-actions";

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "edit-btn";
      editBtn.textContent = "Modifier";
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleEdit(type, item.id);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "delete-btn";
      delBtn.textContent = "Supprimer";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleDelete(type, item.id);
      });

      const archBtn = document.createElement("button");
      archBtn.type = "button";
      archBtn.className = "archive-btn";
      const isArchived = item.status === "archived";
      archBtn.textContent = isArchived ? "Restaurer" : "Archiver";
      archBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleArchive(type, item.id, isArchived ? "active" : "archived");
      });

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      actions.appendChild(archBtn);
      card.appendChild(actions);

      return card;
    }

    function toggleTagFilter(tag) {
      activeTagFilter = activeTagFilter === tag ? null : tag;
      renderAll();
    }

    function renderList(containerId, emptyId, stored, type, onlyActive = true) {
      const container = document.getElementById(containerId);
      const empty = document.getElementById(emptyId);
      container.innerHTML = "";

      let items = stored;
      if (onlyActive) {
        items = items.filter(i => i.status !== "archived");
      }

      if (activeTagFilter) {
        items = items.filter(i => normalizeTags(i.tags).includes(activeTagFilter));
      }

      items = sortByDateDesc(items);

      if (items.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      items.forEach(item => {
        container.appendChild(createCard(item, type));
      });
    }

    function collectAllTags() {
      const storedWatches = loadStored(WATCH_KEY);
      const storedParcels = loadStored(PARCEL_KEY);
      const all = [...storedWatches, ...storedParcels];
      const set = new Set();
      all.forEach(it => normalizeTags(it.tags).forEach(t => set.add(t)));
      return Array.from(set).sort();
    }

    function renderTagFilter() {
      const c = document.getElementById("tag-filter-list");
      c.innerHTML = "";

      const tags = collectAllTags();
      if (tags.length === 0) {
        c.innerHTML = "<span class='small'>Aucun tag pour le moment.</span>";
        return;
      }

      const allBtn = document.createElement("span");
      allBtn.className = "tag-filter-pill" + (activeTagFilter === null ? " active" : "");
      allBtn.textContent = "Tous";
      allBtn.onclick = () => { activeTagFilter = null; renderAll(); };
      c.appendChild(allBtn);

      tags.forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "tag-filter-pill" + (activeTagFilter === tag ? " active" : "");
        pill.textContent = tag;
        pill.onclick = () => {
          activeTagFilter = activeTagFilter === tag ? null : tag;
          renderAll();
        };
        c.appendChild(pill);
      });
    }

    function renderStats() {
      const statsEl = document.getElementById("stats");
      const w = loadStored(WATCH_KEY);
      const p = loadStored(PARCEL_KEY);
      const activeW = w.filter(i => i.status !== "archived").length;
      const archW = w.length - activeW;
      const activeP = p.filter(i => i.status !== "archived").length;
      const archP = p.length - activeP;
      statsEl.textContent =
        `Montres : ${activeW} actives (${archW} archiv√©es) | Colis : ${activeP} actifs (${archP} archiv√©s)`;
    }

    function renderArchive() {
      const container = document.getElementById("archive-container");
      const list = document.getElementById("archive-list");
      const empty = document.getElementById("archive-empty");
      const countEl = document.getElementById("archive-count");
      const arrowEl = document.getElementById("archive-arrow");

      const w = loadStored(WATCH_KEY).map(i => ({ ...i, __type: "watch" }));
      const p = loadStored(PARCEL_KEY).map(i => ({ ...i, __type: "parcel" }));
      let archived = [...w, ...p].filter(i => i.status === "archived");

      if (activeTagFilter) {
        archived = archived.filter(i => normalizeTags(i.tags).includes(activeTagFilter));
      }

      archived = sortByDateDesc(archived);

      countEl.textContent = archived.length;
      list.innerHTML = "";

      if (archived.length === 0) {
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
        archived.forEach(item => {
          list.appendChild(createCard(item, item.__type));
        });
      }

      container.style.display = archiveOpen && archived.length > 0 ? "block" : (archiveOpen ? "block" : "none");
      arrowEl.textContent = archiveOpen ? "‚ñº" : "‚ñ∂";
    }

    function renderBackupInfo() {
      const infoEl = document.getElementById("backup-info");
      try {
        const raw = localStorage.getItem(BACKUP_KEY);
        if (!raw) {
          infoEl.textContent = "Aucune sauvegarde locale pour l'instant.";
          return;
        }
        const data = JSON.parse(raw);
        if (!data || !data.createdAt) {
          infoEl.textContent = "Aucune sauvegarde locale pour l'instant.";
          return;
        }
        const d = new Date(data.createdAt);
        if (isNaN(d.getTime())) {
          infoEl.textContent = "Derni√®re sauvegarde : date inconnue.";
          return;
        }
        infoEl.textContent = "Derni√®re sauvegarde : " + d.toLocaleString("fr-CH");
      } catch {
        infoEl.textContent = "Derni√®re sauvegarde : erreur de lecture.";
      }
    }

    function renderExportPanel() {
      const container = document.getElementById("export-container");
      const arrowEl = document.getElementById("export-arrow");
      container.style.display = exportOpen ? "block" : "none";
      arrowEl.textContent = exportOpen ? "‚ñº" : "‚ñ∂";
    }

    function renderAll() {
      renderList("watch-list", "watch-empty", loadStored(WATCH_KEY), "watch", true);
      renderList("parcel-list", "parcel-empty", loadStored(PARCEL_KEY), "parcel", true);
      renderTagFilter();
      renderStats();
      renderArchive();
      renderBackupInfo();
      renderExportPanel();
    }

    function resetFormMode() {
      editingId = null;
      editingType = null;
      document.getElementById("form-title").textContent = "Ajouter un lien";
      document.getElementById("submit-btn").textContent = "Ajouter";
      document.getElementById("edit-hint").style.display = "none";
      document.getElementById("add-form").reset();
      document.getElementById("createdAt").value = "";
    }

    function handleEdit(type, id) {
      const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
      const arr = loadStored(key);
      const item = arr.find(e => e.id === id);
      if (!item) return;

      editingId = id;
      editingType = type;

      document.getElementById("form-title").textContent = "Modifier un lien";
      document.getElementById("submit-btn").textContent = "Mettre √† jour";
      document.getElementById("edit-hint").style.display = "block";

      document.getElementById("type").value = type;
      document.getElementById("label").value = item.label;
      document.getElementById("url").value = item.url;
      document.getElementById("tags").value = normalizeTags(item.tags).join(", ");
      document.getElementById("createdAt").value = isoToDateInput(item.createdAt);

      const imgInput = document.getElementById("imageUrl");
      imgInput.value = item.imageUrl && !String(item.imageUrl).startsWith("data:")
        ? item.imageUrl
        : "";

      document.getElementById("imageFile").value = "";

      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    function handleDelete(type, id) {
      if (!confirm("Supprimer cette entr√©e ?")) return;
      const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
      const arr = loadStored(key);
      saveStored(key, arr.filter(e => e.id !== id));
      if (editingId === id) resetFormMode();
      updateBackup();
      renderAll();
    }

    function handleArchive(type, id, newStatus) {
      const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
      const arr = loadStored(key);
      const idx = arr.findIndex(e => e.id === id);
      if (idx === -1) return;
      arr[idx].status = newStatus;
      saveStored(key, arr);
      if (editingId === id && newStatus === "archived") {
        resetFormMode();
      }
      updateBackup();
      renderAll();
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderAll();

      const form = document.getElementById("add-form");
      const exportBtn = document.getElementById("export-btn");
      const importBtn = document.getElementById("import-btn");
      const importFileBtn = document.getElementById("import-file-btn");
      const importFileInput = document.getElementById("import-file");
      const exportArea = document.getElementById("export-data");
      const clearBtn = document.getElementById("clear-storage");
      const imageFileInput = document.getElementById("imageFile");
      const imageUrlInput = document.getElementById("imageUrl");
      const archiveToggle = document.getElementById("archive-toggle");
      const exportToggle = document.getElementById("export-toggle");
      const createdAtInput = document.getElementById("createdAt");
      const restoreBackupBtn = document.getElementById("restore-backup");

      archiveToggle.addEventListener("click", () => {
        archiveOpen = !archiveOpen;
        renderArchive();
      });

      exportToggle.addEventListener("click", () => {
        exportOpen = !exportOpen;
        renderExportPanel();
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const type = document.getElementById("type").value;
        const label = document.getElementById("label").value.trim();
        let url = document.getElementById("url").value.trim();
        const tagsRaw = document.getElementById("tags").value.trim();
        const imageUrlField = imageUrlInput.value.trim();
        const file = imageFileInput.files[0];
        const createdAtRaw = createdAtInput.value.trim();

        if (!label || !url) return;
        if (!/^https?:\/\//i.test(url)) {
          url = "https://" + url;
        }

        const tags = normalizeTags(tagsRaw);

        let originalItem = null;
        if (editingId && editingType) {
          const origKey = editingType === "watch" ? WATCH_KEY : PARCEL_KEY;
          const origArr = loadStored(origKey);
          originalItem = origArr.find(e => e.id === editingId) || null;
        }

        function computeCreatedAt(nowIso) {
          if (createdAtRaw) {
            const d = new Date(createdAtRaw + "T12:00:00");
            if (!isNaN(d.getTime())) {
              return d.toISOString();
            }
          }
          return originalItem ? originalItem.createdAt : nowIso;
        }

        function applyEntry(finalImageUrl) {
          const nowIso = new Date().toISOString();
          const status = originalItem && originalItem.status ? originalItem.status : "active";

          const entry = {
            id: editingId || (type + "-" + Date.now() + "-" + Math.random().toString(16).slice(2)),
            label,
            url,
            tags,
            imageUrl: finalImageUrl || imageUrlField || (originalItem && originalItem.imageUrl) || "",
            createdAt: computeCreatedAt(nowIso),
            status
          };

          if (editingId && editingType) {
            const oldKey = editingType === "watch" ? WATCH_KEY : PARCEL_KEY;
            const newKey = type === "watch" ? WATCH_KEY : PARCEL_KEY;

            saveStored(oldKey, loadStored(oldKey).filter(e => e.id !== editingId));

            const newArr = loadStored(newKey);
            newArr.push(entry);
            saveStored(newKey, newArr);
          } else {
            const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
            const arr = loadStored(key);
            arr.push(entry);
            saveStored(key, arr);
          }

          resetFormMode();
          activeTagFilter = null;
          updateBackup();
          renderAll();
        }

        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => applyEntry(ev.target.result);
          reader.readAsDataURL(file);
        } else {
          applyEntry("");
        }
      });

      clearBtn.addEventListener("click", () => {
        if (confirm("Effacer TOUTES les donn√©es locales (montres & colis) ?")) {
          localStorage.removeItem(WATCH_KEY);
          localStorage.removeItem(PARCEL_KEY);
          localStorage.removeItem(BACKUP_KEY);
          activeTagFilter = null;
          resetFormMode();
          renderAll();
        }
      });

      exportBtn.addEventListener("click", () => {
        const data = {
          createdAt: new Date().toISOString(),
          watches: loadStored(WATCH_KEY),
          parcels: loadStored(PARCEL_KEY)
        };
        const json = JSON.stringify(data, null, 2);
        exportArea.value = json;

        try {
          const blob = new Blob([json], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const dateStr = new Date().toISOString().slice(0, 10);
          a.download = `suivi_backup_${dateStr}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch {}
      });

      importBtn.addEventListener("click", () => {
        const txt = exportArea.value.trim();
        if (!txt) return alert("Colle des donn√©es JSON d'abord.");
        try {
          const data = JSON.parse(txt);
          saveStored(WATCH_KEY, Array.isArray(data.watches) ? data.watches : []);
          saveStored(PARCEL_KEY, Array.isArray(data.parcels) ? data.parcels : []);
          resetFormMode();
          activeTagFilter = null;
          updateBackup();
          renderAll();
          alert("Import r√©ussi !");
        } catch {
          alert("JSON invalide.");
        }
      });

      importFileBtn.addEventListener("click", () => {
        importFileInput.click();
      });

      importFileInput.addEventListener("change", () => {
        const file = importFileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const txt = String(ev.target.result || "").trim();
          if (!txt) {
            alert("Fichier vide.");
            return;
          }
          try {
            const data = JSON.parse(txt);
            saveStored(WATCH_KEY, Array.isArray(data.watches) ? data.watches : []);
            saveStored(PARCEL_KEY, Array.isArray(data.parcels) ? data.parcels : []);
            resetFormMode();
            activeTagFilter = null;
            updateBackup();
            renderAll();
            alert("Import depuis fichier r√©ussi !");
          } catch {
            alert("Fichier JSON invalide.");
          }
        };
        reader.readAsText(file);
        importFileInput.value = "";
      });

      restoreBackupBtn.addEventListener("click", () => {
        const raw = localStorage.getItem(BACKUP_KEY);
        if (!raw) {
          alert("Aucun backup trouv√©.");
          return;
        }
        try {
          const data = JSON.parse(raw);
          if (!data || !Array.isArray(data.watches) || !Array.isArray(data.parcels)) {
            alert("Backup invalide.");
            return;
          }
          if (!confirm("Restaurer le dernier backup ? Les donn√©es actuelles seront remplac√©es.")) {
            return;
          }
          saveStored(WATCH_KEY, data.watches);
          saveStored(PARCEL_KEY, data.parcels);
          resetFormMode();
          activeTagFilter = null;
          renderAll();
          alert("Backup restaur√©.");
        } catch {
          alert("Erreur lors de la lecture du backup.");
        }
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      }
    });
  </script>
</body>
</html>
