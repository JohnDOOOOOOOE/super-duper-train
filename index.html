<!doctype html>
<html lang="="fr">
<head>
  <meta charset="utf-8">
  <title>Suivi montres & colis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <style>
    :root {
      color-scheme: light dark;
      --bg: #f9fafb;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --text-muted: #6b7280;
      --accent: #111827;
      --tag-bg: #e5e7eb;
      --tag-text: #374151;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #020617;
        --bg-card: #020617;
        --border: #1e293b;
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --accent: #f9fafb;
        --tag-bg: #111827;
        --tag-text: #e5e7eb;
      }
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      text-align: center;
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.15rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .stats-line {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .lists-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 700px) {
      .lists-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .list { display: flex; flex-direction: column; gap: 0.5rem; }

    .card {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
    }
    .card-main {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      cursor: pointer;
    }
    .card:hover {
      border-color: var(--accent);
    }

    .thumb {
      flex: 0 0 56px;
      height: 56px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #e5e7eb;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-content { flex: 1; min-width: 0; }
    .card-label {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.15rem;
      word-break: break-word;
    }
    .card-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }
    .card-url {
      font-size: 0.75rem;
      color: var(--text-muted);
      word-break: break-all;
    }

    .tags { margin-top: 0.3rem; display: flex; flex-wrap: wrap; gap: 0.25rem; }
    .tag {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: var(--tag-bg);
      color: var(--tag-text);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .tag.active { border-color: var(--accent); }

    .carrier-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #475569;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }
    .card-actions button {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .card-actions .edit-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .card-actions .delete-btn {
      background: #b91c1c;
      color: #f9fafb;
    }

    .empty {
      font-size: 0.9rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .form-container {
      margin-top: 2rem;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
    }

    .form-row { margin-bottom: 0.75rem; }
    label { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }

    input[type="text"], input[type="url"], select, textarea, input[type="file"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #4b5563;
      background: transparent;
      color: inherit;
      font-size: 0.9rem;
    }
    textarea { resize: vertical; }

    button {
      padding: 0.5rem 0.9rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    /* bouton de validation bien contrasté */
    #submit-btn {
      background-color: #111827;
      color: #f9fafb;
    }
    button[type="button"] {
      background: #4b5563;
      color: #f9fafb;
    }

    .export-import {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .tag-filter-container { margin-bottom: 0.75rem; font-size: 0.85rem; }
    .tag-filter-list { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.25rem; }
    .tag-filter-pill {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: var(--tag-bg);
      color: var(--tag-text);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .tag-filter-pill.active { border-color: var(--accent); }

    .export-layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .export-left { flex: 1; }
    .export-right { align-self: flex-end; }
    @media (min-width: 600px) {
      .export-layout {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      .export-left { margin-right: 1rem; }
      .export-right { text-align: right; }
    }
    #export-data { min-height: 80px; width: 100%; }
  </style>
</head>

<body>
  <h1>Suivi montres & colis</h1>
  <p class="subtitle">Application Web installable – liens Tempora & colis, avec tags, photos, édition & stats.</p>
  <p id="stats" class="stats-line"></p>

  <!-- Filtre par tag -->
  <div class="tag-filter-container">
    <span class="tag-filter-label">Filtrer par tag :</span>
    <div id="tag-filter-list" class="tag-filter-list"></div>
  </div>

  <!-- Deux colonnes (Montres / Colis) -->
  <div class="lists-container">
    <div class="section">
      <h2>Montres</h2>
      <div id="watch-list" class="list"></div>
      <p id="watch-empty" class="empty" style="display:none;">Aucune montre enregistrée.</p>
    </div>

    <div class="section">
      <h2>Colis</h2>
      <div id="parcel-list" class="list"></div>
      <p id="parcel-empty" class="empty" style="display:none;">Aucun colis enregistré.</p>
    </div>
  </div>

  <!-- Formulaire -->
  <div class="form-container">
    <h2 id="form-title">Ajouter un lien</h2>
    <form id="add-form">
      <div class="form-row">
        <label>Catégorie</label>
        <select id="type">
          <option value="watch">Montre</option>
          <option value="parcel">Colis</option>
        </select>
      </div>

      <div class="form-row">
        <label>Nom / Descriptif</label>
        <input id="label" type="text" required placeholder="Ex : Tank Must révision, Colis UPS…">
      </div>

      <div class="form-row">
        <label>Lien de suivi</label>
        <input id="url" type="url" required placeholder="https://...">
      </div>

      <div class="form-row">
        <label>Tags (séparés par virgules)</label>
        <input id="tags" type="text" placeholder="vintage, UPS, révision…">
      </div>

      <div class="form-row">
        <label>Image (URL ou depuis l'appareil)</label>
        <input id="imageUrl" type="url" placeholder="https://image.jpg (optionnel)">
        <input id="imageFile" type="file" accept="image/*">
        <p class="small">
          Tu peux soit coller une URL d'image, soit choisir une image locale (elle sera stockée dans l'app).
        </p>
      </div>

      <div class="form-row">
        <button id="submit-btn" type="submit">Ajouter</button>
        <p class="small" id="edit-hint" style="display:none;">
          Mode édition activé – tu modifies une entrée existante.
        </p>
      </div>
    </form>

    <div class="export-import">
      <h2>Exporter / Importer</h2>
      <div class="export-layout">
        <div class="export-left">
          <div class="form-row">
            <button type="button" id="export-btn">Exporter</button>
            <button type="button" id="import-btn">Importer</button>
          </div>
          <div class="form-row">
            <label for="export-data">Données JSON</label>
            <textarea id="export-data" placeholder="Exporter puis copier, ou coller ici pour importer."></textarea>
          </div>
        </div>
        <div class="export-right">
          <button type="button" id="clear-storage">Effacer toutes les données locales</button>
          <p class="small">
            Ce bouton supprime toutes les montres & colis stockés localement sur cet appareil.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const defaultWatches = [];
    const defaultParcels = [];

    const WATCH_KEY = "watchLinksV2";
    const PARCEL_KEY = "parcelLinksV2";
    let activeTagFilter = null;
    let editingId = null;
    let editingType = null;

    function enrichEntries(key, arr) {
      let changed = false;
      arr.forEach((item) => {
        if (!item.id) {
          item.id = key + "-" + Date.now() + "-" + Math.random().toString(16).slice(2);
          changed = true;
        }
        if (!item.createdAt) {
          item.createdAt = new Date().toISOString();
          changed = true;
        }
      });
      if (changed) {
        localStorage.setItem(key, JSON.stringify(arr));
      }
      return arr;
    }

    function loadStored(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return enrichEntries(key, parsed);
      } catch {
        return [];
      }
    }

    function saveStored(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }

    function normalizeTags(tags) {
      if (!tags) return [];
      return String(tags)
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString("fr-CH");
      } catch {
        return "";
      }
    }

    function detectCarrier(url) {
      const lower = (url || "").toLowerCase();
      if (lower.includes("ups")) return "UPS";
      if (lower.includes("laposte") || lower.includes("poste.ch") || lower.includes("post.ch")) return "La Poste";
      if (lower.includes("dhl")) return "DHL";
      if (lower.includes("fedex")) return "FedEx";
      if (lower.includes("chronopost")) return "Chronopost";
      if (lower.includes("colissimo")) return "Colissimo";
      return null;
    }

    function createCard(item, isWatch) {
      const card = document.createElement("div");
      card.className = "card";

      const main = document.createElement("div");
      main.className = "card-main";
      main.addEventListener("click", () => {
        if (item.url) {
          window.open(item.url, "_blank", "noopener");
        }
      });

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if (item.imageUrl) {
        const img = document.createElement("img");
        img.src = item.imageUrl;
        img.alt = item.label || "";
        thumb.appendChild(img);
      } else {
        thumb.textContent = isWatch ? "Montre" : "Colis";
      }

      const content = document.createElement("div");
      content.className = "card-content";

      const labelEl = document.createElement("div");
      labelEl.className = "card-label";
      labelEl.textContent = item.label || (isWatch ? "Montre" : "Colis");

      const metaEl = document.createElement("div");
      metaEl.className = "card-meta";
      const dateText = formatDate(item.createdAt);
      if (dateText) {
        const dateSpan = document.createElement("span");
        dateSpan.textContent = "Ajouté le " + dateText;
        metaEl.appendChild(dateSpan);
      }

      if (!isWatch) {
        const carrier = detectCarrier(item.url);
        if (carrier) {
          const carrierSpan = document.createElement("span");
          carrierSpan.className = "carrier-badge";
          carrierSpan.textContent = carrier;
          metaEl.appendChild(carrierSpan);
        }
      }

      const urlEl = document.createElement("div");
      urlEl.className = "card-url";
      urlEl.textContent = item.url || "";

      content.appendChild(labelEl);
      if (metaEl.childNodes.length > 0) content.appendChild(metaEl);
      content.appendChild(urlEl);

      const tags = normalizeTags(item.tags);
      if (tags.length > 0) {
        const tagsEl = document.createElement("div");
        tagsEl.className = "tags";
        tags.forEach(tag => {
          const t = document.createElement("span");
          t.className = "tag";
          if (activeTagFilter === tag) t.classList.add("active");
          t.textContent = tag;
          t.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleTagFilter(tag);
          });
          tagsEl.appendChild(t);
        });
        content.appendChild(tagsEl);
      }

      main.appendChild(thumb);
      main.appendChild(content);
      card.appendChild(main);

      const actions = document.createElement("div");
      actions.className = "card-actions";

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "edit-btn";
      editBtn.textContent = "Modifier";
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleEdit(isWatch ? "watch" : "parcel", item.id);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "delete-btn";
      delBtn.textContent = "Supprimer";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleDelete(isWatch ? "watch" : "parcel", item.id);
      });

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      card.appendChild(actions);

      return card;
    }

    function renderList(containerId, emptyId, defaults, stored, isWatch) {
      const container = document.getElementById(containerId);
      const empty = document.getElementById(emptyId);
      container.innerHTML = "";

      const items = [...defaults, ...stored];
      const filtered = activeTagFilter
        ? items.filter(i => normalizeTags(i.tags).includes(activeTagFilter))
        : items;

      if (filtered.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      filtered.forEach(item => {
        container.appendChild(createCard(item, isWatch));
      });
    }

    function collectAllTags() {
      const storedWatches = loadStored(WATCH_KEY);
      const storedParcels = loadStored(PARCEL_KEY);
      const all = [
        ...defaultWatches,
        ...defaultParcels,
        ...storedWatches,
        ...storedParcels
      ];
      const set = new Set();
      all.forEach(it => normalizeTags(it.tags).forEach(t => set.add(t)));
      return Array.from(set).sort();
    }

    function renderTagFilter() {
      const c = document.getElementById("tag-filter-list");
      c.innerHTML = "";

      const tags = collectAllTags();
      if (tags.length === 0) {
        c.innerHTML = "<span class='small'>Aucun tag pour le moment.</span>";
        return;
      }

      const allBtn = document.createElement("span");
      allBtn.className = "tag-filter-pill" + (activeTagFilter === null ? " active" : "");
      allBtn.textContent = "Tous";
      allBtn.onclick = () => { activeTagFilter = null; renderAll(); };
      c.appendChild(allBtn);

      tags.forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "tag-filter-pill" + (activeTagFilter === tag ? " active" : "");
        pill.textContent = tag;
        pill.onclick = () => {
          activeTagFilter = activeTagFilter === tag ? null : tag;
          renderAll();
        };
        c.appendChild(pill);
      });
    }

    function renderStats() {
      const statsEl = document.getElementById("stats");
      if (!statsEl) return;
      const w = loadStored(WATCH_KEY);
      const p = loadStored(PARCEL_KEY);
      statsEl.textContent = "Montres : " + w.length + " | Colis : " + p.length;
    }

    function renderAll() {
      renderList("watch-list", "watch-empty", defaultWatches, loadStored(WATCH_KEY), true);
      renderList("parcel-list", "parcel-empty", defaultParcels, loadStored(PARCEL_KEY), false);
      renderTagFilter();
      renderStats();
    }

    function resetFormMode() {
      editingId = null;
      editingType = null;
      document.getElementById("form-title").textContent = "Ajouter un lien";
      document.getElementById("submit-btn").textContent = "Ajouter";
      document.getElementById("edit-hint").style.display = "none";
      document.getElementById("add-form").reset();
    }

    function handleEdit(type, id) {
      const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
      const arr = loadStored(key);
      const item = arr.find(e => e.id === id);
      if (!item) return;

      editingId = id;
      editingType = type;

      document.getElementById("form-title").textContent = "Modifier un lien";
      document.getElementById("submit-btn").textContent = "Mettre à jour";
      document.getElementById("edit-hint").style.display = "block";

      document.getElementById("type").value = type;
      document.getElementById("label").value = item.label || "";
      document.getElementById("url").value = item.url || "";
      document.getElementById("tags").value = normalizeTags(item.tags).join(", ");
      const imgInput = document.getElementById("imageUrl");
      const fileInput = document.getElementById("imageFile");
      imgInput.value = item.imageUrl && !String(item.imageUrl).startsWith("data:")
        ? item.imageUrl
        : "";
      fileInput.value = "";

      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    function handleDelete(type, id) {
      if (!confirm("Supprimer cette entrée ?")) return;
      const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
      const arr = loadStored(key);
      const filtered = arr.filter(e => e.id !== id);
      saveStored(key, filtered);
      if (editingId === id) {
        resetFormMode();
      }
      renderAll();
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderAll();

      const form = document.getElementById("add-form");
      const exportBtn = document.getElementById("export-btn");
      const importBtn = document.getElementById("import-btn");
      const exportArea = document.getElementById("export-data");
      const clearBtn = document.getElementById("clear-storage");
      const imageFileInput = document.getElementById("imageFile");
      const imageUrlInput = document.getElementById("imageUrl");

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const type = document.getElementById("type").value;
        const label = document.getElementById("label").value.trim();
        let url = document.getElementById("url").value.trim();
        const tagsRaw = document.getElementById("tags").value.trim();
        const imageUrlField = imageUrlInput.value.trim();
        const file = imageFileInput.files[0];

        if (!label || !url) return;
        if (!/^https?:\/\//i.test(url)) {
          url = "https://" + url;
        }

        const tags = normalizeTags(tagsRaw);

        let originalItem = null;
        if (editingId && editingType) {
          const originalKey = editingType === "watch" ? WATCH_KEY : PARCEL_KEY;
          const originalArr = loadStored(originalKey);
          originalItem = originalArr.find(e => e.id === editingId) || null;
        }

        function applyEntry(finalImageUrl) {
          const nowIso = new Date().toISOString();
          const baseImage =
            finalImageUrl ||
            imageUrlField ||
            (originalItem && originalItem.imageUrl) ||
            "";

          const entry = {
            id: editingId || (type + "-" + Date.now() + "-" + Math.random().toString(16).slice(2)),
            label,
            url,
            tags,
            imageUrl: baseImage,
            createdAt: (originalItem && originalItem.createdAt) ? originalItem.createdAt : nowIso
          };

          if (editingId && editingType) {
            const oldKey = editingType === "watch" ? WATCH_KEY : PARCEL_KEY;
            const newKey = type === "watch" ? WATCH_KEY : PARCEL_KEY;

            const oldArr = loadStored(oldKey).filter(e => e.id !== editingId);
            saveStored(oldKey, oldArr);

            const newArr = loadStored(newKey);
            newArr.push(entry);
            saveStored(newKey, newArr);
          } else {
            const key = type === "watch" ? WATCH_KEY : PARCEL_KEY;
            const arr = loadStored(key);
            arr.push(entry);
            saveStored(key, arr);
          }

          resetFormMode();
          activeTagFilter = null;
          renderAll();
        }

        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            applyEntry(ev.target.result);
          };
          reader.readAsDataURL(file);
        } else {
          applyEntry("");
        }
      });

      clearBtn.addEventListener("click", () => {
        if (confirm("Effacer toutes les données locales (montres & colis) sur cet appareil ?")) {
          localStorage.removeItem(WATCH_KEY);
          localStorage.removeItem(PARCEL_KEY);
          activeTagFilter = null;
          resetFormMode();
          renderAll();
        }
      });

      exportBtn.addEventListener("click", () => {
        exportArea.value = JSON.stringify({
          watches: loadStored(WATCH_KEY),
          parcels: loadStored(PARCEL_KEY)
        }, null, 2);
      });

      importBtn.addEventListener("click", () => {
        const txt = exportArea.value.trim();
        if (!txt) {
          alert("Colle des données JSON avant d'importer.");
          return;
        }
        try {
          const data = JSON.parse(txt);
          const watches = Array.isArray(data.watches) ? data.watches : [];
          const parcels = Array.isArray(data.parcels) ? data.parcels : [];
          saveStored(WATCH_KEY, watches);
          saveStored(PARCEL_KEY, parcels);
          activeTagFilter = null;
          resetFormMode();
          renderAll();
          alert("Import réussi !");
        } catch {
          alert("JSON invalide.");
        }
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      }
    });
  </script>
</body>
</html>
