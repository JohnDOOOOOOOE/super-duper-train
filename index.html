<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi – Montres & Colis</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">

<style>
/* ---------- THEME ---------- */
:root {
  color-scheme: light dark;
  --bg: #f9fafb; --bg-card:#ffffff; --border:#e5e7eb;
  --text:#111827; --text-muted:#6b7280; --accent:#111827;
}
@media(prefers-color-scheme:dark){
  :root{
    --bg:#020617; --bg-card:#020617; --border:#1e293b;
    --text:#e5e7eb; --text-muted:#9ca3af; --accent:#f9fafb;
  }
}

/* ---------- STRUCTURE ---------- */
body {
  margin:0 auto; max-width:800px; padding:1rem;
  font-family:system-ui; background:var(--bg); color:var(--text);
}
h1 {text-align:center;margin:0.5rem 0 0.2rem;}
h2 {margin:1.5rem 0 0.6rem;font-size:1.15rem;}
.subtitle{text-align:center;color:var(--text-muted);font-size:0.85rem;margin:0;}
.stats{text-align:center;color:var(--text-muted);margin:1rem 0;font-size:0.8rem;}

.section-list{display:grid;gap:1rem;}
@media(min-width:700px){.section-list{grid-template-columns:1fr 1fr;}}

.list{display:flex;flex-direction:column;gap:0.5rem;}
.empty{color:var(--text-muted);font-style:italic;}

button{cursor:pointer;border:none;border-radius:0.5rem;font-size:0.85rem;padding:0.4rem 0.8rem;}
.action-btn{border-radius:999px;padding:0.25rem 0.6rem;font-size:0.75rem;}

.clear-btn{background:#b91c1c;color:white;}
.clear-btn:hover{background:#dc2626;}

/* ---------- CARD ---------- */
.card{
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:0.75rem;padding:0.7rem;display:flex;flex-direction:column;gap:0.4rem;
}
.card-main{display:flex;gap:0.7rem;cursor:pointer;}
.thumb{
  width:56px;height:56px;border-radius:0.4rem;overflow:hidden;
  background:#0f172a;display:flex;align-items:center;justify-content:center;color:white;font-size:0.75rem;
}
.thumb img{width:100%;height:100%;object-fit:cover;}

.card-label{font-weight:600;font-size:0.95rem;}
.card-meta{color:var(--text-muted);font-size:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;}

.tag{padding:0.1rem 0.5rem;border-radius:999px;font-size:0.7rem;background:#e5e7eb;color:#374151;}
@media(prefers-color-scheme:dark){.tag{background:#111827;color:#e5e7eb;}}
.tag.active{border:1px solid var(--accent);}

.carrier{background:#0f172a;color:white;border:1px solid #475569;}
.status{border:1px solid #4b5563;}

/* ---------- PANELS ---------- */
.panel-toggle{
  width:100%;background:transparent;border:1px solid var(--border);
  border-radius:0.75rem;padding:0.5rem 0.7rem;text-align:left;
  display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;
}
.panel{display:none;margin-top:0.5rem;}

/* ---------- FORM ---------- */
.form-box{
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:0.75rem;padding:1rem;margin-top:2rem;
}
.form-row{margin-bottom:0.8rem;}
input,select,textarea{
  width:100%;padding:0.4rem;border-radius:0.4rem;
  border:1px solid #4b5563;background:transparent;color:inherit;
}
textarea{resize:vertical;}
.small{font-size:0.8rem;color:var(--text-muted);}
</style>
</head>

<body>

<h1>Suivi montres & colis</h1>
<p class="subtitle">Application installable – photos, tags, archivage, import/export</p>
<p id="stats" class="stats"></p>

<!-- TAG FILTERS -->
<div id="tag-filters"></div>

<!-- LISTS -->
<div class="section-list">
  <div>
    <h2>Montres</h2>
    <div id="watch-list" class="list"></div>
    <p id="watch-empty" class="empty" style="display:none;">Aucune entrée.</p>
  </div>
  <div>
    <h2>Colis</h2>
    <div id="parcel-list" class="list"></div>
    <p id="parcel-empty" class="empty" style="display:none;">Aucune entrée.</p>
  </div>
</div>

<!-- FORMULAIRE -->
<div class="form-box">
  <h2 id="form-title">Ajouter un lien</h2>
  <form id="form">
    <div class="form-row">
      <label>Catégorie</label>
      <select id="type">
        <option value="watch">Montre</option>
        <option value="parcel">Colis</option>
      </select>
    </div>

    <div class="form-row">
      <label>Nom</label>
      <input id="label" required placeholder="Ex : Révision Seiko">
    </div>

    <div class="form-row">
      <label>Lien de suivi</label>
      <input id="url" required placeholder="https://...">
    </div>

    <div class="form-row">
      <label>Tags (séparés par virgules)</label>
      <input id="tags">
    </div>

    <div class="form-row">
      <label>Date d’ajout</label>
      <input type="date" id="createdAt">
    </div>

    <div class="form-row">
      <label>Image (URL ou fichier)</label>
      <input id="imgUrl" placeholder="https://image.jpg">
      <input type="file" id="imgFile" accept="image/*">
    </div>

    <button id="submit" style="background:#111827;color:white;">Ajouter</button>
    <p id="edit-note" class="small" style="display:none;">Mode édition activé.</p>
  </form>
</div>

<!-- ARCHIVES -->
<div style="margin-top:2rem;">
  <button class="panel-toggle" id="toggle-arch"><span id="arrow-arch">▶</span> Archivés (<span id="arch-count">0</span>)</button>
  <div class="panel" id="arch-panel">
    <div id="archive-list" class="list"></div>
    <p id="archive-empty" class="empty" style="display:none;">Rien en archive.</p>
  </div>
</div>

<!-- EXPORT / IMPORT -->
<div style="margin-top:2rem;">
  <button class="panel-toggle" id="toggle-exp"><span id="arrow-exp">▶</span> Export / Import / Backup</button>
  <div class="panel" id="exp-panel">

    <button id="export">Exporter (.txt)</button>
    <button id="import-text">Importer depuis texte</button>
    <button id="import-file-btn">Importer fichier</button>
    <input type="file" id="import-file" accept=".txt,.json" style="display:none">

    <textarea id="json-area" placeholder="Zone d’export/import…" style="margin-top:1rem;"></textarea>

    <button id="restore">Restaurer dernier backup</button>
    <p id="backup-info" class="small"></p>

    <button class="clear-btn" id="clear-all">Effacer toutes les données</button>
  </div>
</div>

<script>
/* =========================
    STOCKAGE + HELPERS
========================= */

const K_W = "watchData";
const K_P = "parcelData";
const K_B = "backupData";

let editId = null;
let editType = null;
let filterTag = null;

const get = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v) => {
  try{ localStorage.setItem(k, JSON.stringify(v)); }
  catch(e){ alert("Stockage plein. Supprimez des photos."); }
};

const normalizeTags = t => t ? t.split(",").map(x=>x.trim()).filter(Boolean) : [];
const fmtDate = iso => new Date(iso).toLocaleDateString("fr-CH");
const sortByDate = arr => arr.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

/* Detect transporteur */
const detectCarrier = url => {
  url = url.toLowerCase();
  if(url.includes("ups")) return "UPS";
  if(url.includes("dhl")) return "DHL";
  if(url.includes("fedex")) return "FedEx";
  if(url.includes("poste")) return "La Poste";
  if(url.includes("chronopost")) return "Chronopost";
  return null;
};

/* BACKUP SANS IMAGES */
const stripImages = arr => arr.map(o=>{
  o={...o};
  if(o.imageUrl && o.imageUrl.startsWith("data:")) delete o.imageUrl;
  return o;
});

function backup() {
  const data = {
    createdAt: new Date().toISOString(),
    watches: stripImages(get(K_W)),
    parcels: stripImages(get(K_P))
  };
  try{
    localStorage.setItem(K_B, JSON.stringify(data));
  }catch{}
  renderBackupInfo();
}

/* =========================
      RENDER LOGIC
========================= */

function render() {
  renderList("watch", get(K_W));
  renderList("parcel", get(K_P));
  renderTags();
  renderStats();
  renderArchive();
  renderBackupInfo();
}

function renderList(type, arr){
  const list = document.getElementById(type+"-list");
  const empty = document.getElementById(type+"-empty");
  list.innerHTML = "";

  let items = arr.filter(x=>x.status!=="archived");
  if(filterTag) items = items.filter(x=>normalizeTags(x.tags).includes(filterTag));
  items = sortByDate(items);

  empty.style.display = items.length ? "none" : "block";

  items.forEach(x=> list.appendChild(card(x,type)));
}

function card(item,type){
  const c = document.createElement("div");
  c.className="card";

  const main = document.createElement("div");
  main.className="card-main";
  main.onclick = ()=>window.open(item.url,"_blank");

  const th = document.createElement("div"); th.className="thumb";
  if(item.imageUrl){ const img=new Image(); img.src=item.imageUrl; th.appendChild(img); }
  else th.textContent = type==="watch"?"Montre":"Colis";

  const content = document.createElement("div");
  content.innerHTML = `
    <div class="card-label">${item.label}</div>
    <div class="card-meta">
      <span>Ajouté le ${fmtDate(item.createdAt)}</span>
      <span class="status">${item.status==="archived"?"Archivé":"Actif"}</span>
      ${type==="parcel" && detectCarrier(item.url) ? `<span class="tag carrier">${detectCarrier(item.url)}</span>`:""}
    </div>
  `;

  const tagBox=document.createElement("div");
  tagBox.style.marginTop="0.3rem";
  normalizeTags(item.tags).forEach(t=>{
    const tg=document.createElement("span");
    tg.className="tag"+(t===filterTag?" active":"");
    tg.textContent=t;
    tg.onclick=e=>{
      e.stopPropagation();
      filterTag = (filterTag===t?null:t);
      render();
    };
    tagBox.appendChild(tg);
  });
  if(tagBox.childNodes.length) content.appendChild(tagBox);

  main.append(th,content);
  c.appendChild(main);

  const acts=document.createElement("div");
  acts.style.marginTop="0.3rem"; acts.style.display="flex"; acts.style.gap="0.4rem";

  const edit=document.createElement("button");
  edit.textContent="Modifier"; edit.className="action-btn";
  edit.onclick=e=>{ e.stopPropagation(); loadEdit(item,type); };

  const del=document.createElement("button");
  del.textContent="Supprimer"; del.className="action-btn"; del.style.background="#b91c1c"; del.style.color="white";
  del.onclick=e=>{ e.stopPropagation(); removeItem(item.id,type); };

  const arc=document.createElement("button");
  arc.textContent=item.status==="archived"?"Restaurer":"Archiver";
  arc.className="action-btn"; arc.style.background="#1d4ed8"; arc.style.color="white";
  arc.onclick=e=>{ e.stopPropagation(); toggleArchive(item.id,type); };

  acts.append(edit,del,arc);
  c.appendChild(acts);
  return c;
}

function renderTags(){
  const box=document.getElementById("tag-filters");
  box.innerHTML="";

  const tags=new Set();
  [...get(K_W),...get(K_P)].forEach(x=>normalizeTags(x.tags).forEach(t=>tags.add(t)));

  if(!tags.size) return;

  const all=document.createElement("button");
  all.textContent="Tous";
  all.className="tag"+(filterTag? "":" active");
  all.onclick=()=>{filterTag=null;render();}
  box.appendChild(all);

  [...tags].sort().forEach(t=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.className="tag"+(filterTag===t?" active":"");
    b.onclick=()=>{filterTag=filterTag===t?null:t;render();}
    box.appendChild(b);
  });
}

function renderStats(){
  const w=get(K_W), p=get(K_P);
  const wA=w.filter(x=>x.status!=="archived").length;
  const pA=p.filter(x=>x.status!=="archived").length;
  document.getElementById("stats").textContent=
    `Montres : ${wA} | Colis : ${pA}`;
}

function renderArchive(){
  const panel=document.getElementById("arch-panel");
  const count=document.getElementById("arch-count");
  const list=document.getElementById("archive-list");
  const empty=document.getElementById("archive-empty");
  list.innerHTML="";

  let arch=[...get(K_W).map(x=>({...x,__t:"watch"})),...get(K_P).map(x=>({...x,__t:"parcel"}))]
    .filter(x=>x.status==="archived");

  if(filterTag) arch=arch.filter(x=>normalizeTags(x.tags).includes(filterTag));
  arch=sortByDate(arch);

  count.textContent=arch.length;
  empty.style.display = arch.length?"none":"block";

  arch.forEach(x=>list.appendChild(card(x,x.__t)));
}

function renderBackupInfo(){
  const raw=localStorage.getItem(K_B);
  const box=document.getElementById("backup-info");

  if(!raw){ box.textContent="Aucun backup."; return; }
  try{
    const d=new Date(JSON.parse(raw).createdAt);
    box.textContent="Sauvegarde : "+d.toLocaleString("fr-CH");
  }catch{ box.textContent="Backup illisible."; }
}

/* =========================
      CRUD LOGIC
========================= */

function loadEdit(item,type){
  editId=item.id; editType=type;
  document.getElementById("form-title").textContent="Modifier un lien";
  document.getElementById("edit-note").style.display="block";

  document.getElementById("type").value=type;
  document.getElementById("label").value=item.label;
  document.getElementById("url").value=item.url;
  document.getElementById("tags").value=normalizeTags(item.tags).join(", ");
  document.getElementById("createdAt").value=item.createdAt.slice(0,10);
  document.getElementById("imgUrl").value=item.imageUrl||"";
  document.getElementById("imgFile").value="";
  window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
}

function removeItem(id,type){
  if(!confirm("Supprimer ?"))return;
  const k=type==="watch"?K_W:K_P;
  save(k,get(k).filter(x=>x.id!==id));
  resetForm();
  backup();
  render();
}

function toggleArchive(id,type){
  const k=type==="watch"?K_W:K_P;
  const arr=get(k);
  const it=arr.find(x=>x.id===id);
  if(!it)return;
  it.status = it.status==="archived"?"active":"archived";
  save(k,arr);
  backup();
  render();
}

/* =========================
        FORM SUBMIT
========================= */

document.getElementById("form").onsubmit = e =>{
  e.preventDefault();

  const type=document.getElementById("type").value;
  const label=document.getElementById("label").value.trim();
  let url=document.getElementById("url").value.trim();
  const tags=normalizeTags(document.getElementById("tags").value);
  const file=document.getElementById("imgFile").files[0];
  const imgUrlField=document.getElementById("imgUrl").value.trim();
  const dateField=document.getElementById("createdAt").value;
  if(!url.startsWith("http")) url="https://"+url;

  const k = type==="watch"?K_W:K_P;
  const arr=get(k);

  const existing = editId ? get(editType==="watch"?K_W:K_P).find(x=>x.id===editId) : null;

  const finalDate = dateField ?
      new Date(dateField+"T12:00:00").toISOString() :
      (existing ? existing.createdAt : new Date().toISOString());

  function add(finalImg){
    const obj = {
      id: editId || (type+"-"+Date.now()),
      label, url, tags,
      createdAt: finalDate,
      status: existing ? existing.status : "active",
      imageUrl: finalImg || imgUrlField || (existing?existing.imageUrl:"")
    };

    if(editId){
      /* Suppression ancienne entrée */
      const oldK = editType==="watch"?K_W:K_P;
      save(oldK, get(oldK).filter(x=>x.id!==editId));
    }

    /* Ajout */
    const newArr=get(k);
    newArr.push(obj);
    save(k,newArr);

    resetForm();
    filterTag=null;
    backup();
    render();
  }

  if(file){
    const r=new FileReader();
    r.onload = e=> add(e.target.result);
    r.readAsDataURL(file);
  }else add(null);
};

function resetForm(){
  editId=null; editType=null;
  document.getElementById("form").reset();
  document.getElementById("form-title").textContent="Ajouter un lien";
  document.getElementById("edit-note").style.display="none";
}

/* =========================
       EXPORT / IMPORT
========================= */

document.getElementById("export").onclick=()=>{
  const data = {
    createdAt:new Date().toISOString(),
    watches:get(K_W),
    parcels:get(K_P)
  };
  const txt=JSON.stringify(data,null,2);
  document.getElementById("json-area").value=txt;

  const blob=new Blob([txt],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="suivi_backup.txt";
  a.click();
};

document.getElementById("import-text").onclick=()=>{
  try{
    const d=JSON.parse(document.getElementById("json-area").value);
    save(K_W,d.watches||[]);
    save(K_P,d.parcels||[]);
    resetForm(); filterTag=null;
    backup(); render();
    alert("Import réussi.");
  }catch{ alert("JSON invalide."); }
};

document.getElementById("import-file-btn").onclick=()=>document.getElementById("import-file").click();
document.getElementById("import-file").onchange=e=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=function(ev){
    try{
      const d=JSON.parse(ev.target.result);
      save(K_W,d.watches||[]);
      save(K_P,d.parcels||[]);
      resetForm(); filterTag=null;
      backup(); render();
      alert("Import OK.");
    }catch{ alert("Fichier invalide."); }
  };
  r.readAsText(f);
};

document.getElementById("restore").onclick=()=>{
  const raw=localStorage.getItem(K_B);
  if(!raw)return alert("Aucun backup.");
  if(!confirm("Restaurer backup ?"))return;
  try{
    const d=JSON.parse(raw);
    save(K_W, d.watches||[]);
    save(K_P, d.parcels||[]);
    render();
  }catch{ alert("Backup corrompu."); }
};

document.getElementById("clear-all").onclick=()=>{
  if(confirm("Effacer toutes les données ?")){
    localStorage.removeItem(K_W);
    localStorage.removeItem(K_P);
    localStorage.removeItem(K_B);
    render();
  }
};

/* =========================
      PANELS
========================= */

document.getElementById("toggle-arch").onclick=()=>{
  const p=document.getElementById("arch-panel");
  const a=document.getElementById("arrow-arch");
  const open=p.style.display==="block";
  p.style.display=open?"none":"block";
  a.textContent=open?"▶":"▼";
};

document.getElementById("toggle-exp").onclick=()=>{
  const p=document.getElementById("exp-panel");
  const a=document.getElementById("arrow-exp");
  const open=p.style.display==="block";
  p.style.display=open?"none":"block";
  a.textContent=open?"▶":"▼";
};

/* =========================
     SERVICE WORKER
========================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

/* Initial render */
render();
</script>
</body>
</html>
